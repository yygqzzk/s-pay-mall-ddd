<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼å›¢é¡¹ç›® - å•†å“è¯¦æƒ…é¡µ</title>
    <link rel="stylesheet" href="css/index.css">

    <!-- Element UI æ ·å¼ -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- Vueï¼ˆElement UIä¾èµ–ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <!-- Element UI -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>
<body>

<!-- è½®æ’­å›¾ -->
<div class="swiper-container">
    <div class="swiper-wrapper">
        <div class="swiper-slide"><img src="./images/sku-13811216-01.png"></div>
        <div class="swiper-slide"><img src="./images/sku-13811216-02.png"></div>
        <div class="swiper-slide"><img src="./images/sku-13811216-03.png"></div>
    </div>
    <div class="swiper-pagination"></div>
</div>

<!-- å•†å“ä¿¡æ¯ -->
<div class="product-info">
    <h1 class="product-title">æ‰‹å†™MyBatisï¼šæ¸è¿›å¼æºç å®è·µï¼ˆå…¨å½©ï¼‰</h1>
    <span class="promotion-tag">å¤§ä¿ƒä¼˜æƒ </span>
    <span class="promotion-text"></span>
</div>

<!-- æ‹¼å•åˆ—è¡¨å®¹å™¨ -->
<div class="group-list"></div>
<div class="area"></div>

<!-- åº•éƒ¨æ“ä½œæ  -->
<div class="action-bar">
    <button class="action-btn buy-alone"></button>
    <button class="action-btn group-buy"></button>
</div>

<script src="js/index.js"></script>
<script>
    function showPaymentConfirm(price) {
        const overlay = document.createElement('div');
        overlay.className = 'payment-overlay';

        const modal = document.createElement('div');
        modal.className = 'payment-modal';
        modal.innerHTML = `
      <h3>æ”¯ä»˜ç¡®è®¤</h3>
      <p>å•†å“é‡‘é¢ï¼šï¿¥${price}</p>
      <p>ä¹°å®¶è´¦å·ï¼š<span class="copyable" data-copy="nagsao4724@sandbox.com">nagsao4724@sandbox.com</span></p>
      <p>ç™»å½•å¯†ç ï¼š111111</p>
      <p>æ”¯ä»˜å¯†ç ï¼š111111</p>
      <div class="modal-buttons">
          <button class="confirm-btn">ç¡®è®¤æ”¯ä»˜</button>
          <button class="cancel-btn">å–æ¶ˆæ”¯ä»˜</button>
      </div>
  `;

        modal.querySelector('.confirm-btn').addEventListener('click', function () {
            const form = document.querySelector('form');
            if (form) form.submit();
            overlay.remove();
        });

        modal.querySelector('.cancel-btn').addEventListener('click', function () {
            document.querySelectorAll('form').forEach(form => form.remove());
            overlay.remove();
        });

        modal.querySelector('.copyable').addEventListener('click', function () {
            const textToCopy = this.getAttribute('data-copy');
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('ä¹°å®¶è´¦å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                ELEMENT.Message.error('å¤åˆ¶å¤±è´¥ï¼š' + err.message);
            });
        });

        overlay.appendChild(modal);
        document.body.appendChild(overlay);
    }

    function obfuscateUserId(userId) {
        if (userId.length <= 4) {
            return userId;
        } else {
            const start = userId.slice(0, 2);
            const end = userId.slice(-2);
            const middle = '*'.repeat(userId.length - 4);
            return `${start}${middle}${end}`;
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        var sPayMallUrl = "http://127.0.0.1:8080";
        var groupBuyMarketUrl = "http://127.0.0.1:8090";
        var goodsId = "9890001";

        var userId = getCookie("loginToken");
        if (!userId) {
            window.location.href = "login.html";
            return;
        }

        fetch(groupBuyMarketUrl + '/api/v1/gbm/index/query_group_buy_market_config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: userId,
                source: "s01",
                channel: "c01",
                goodsId: goodsId
            })
        })
            .then(response => response.json())
            .then(res => {
                if (res.code !== '0000') {
                    ELEMENT.Message.error('åŠ è½½å¤±è´¥ï¼š' + (res.info || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }

                const { activityId, goods, teamList, teamStatistic } = res.data;
                const groupList = document.querySelector('.group-list');
                const promotionText = document.querySelector('.promotion-text');

                promotionText.textContent = `ç›´é™ Â¥${goods.deductionPrice.toFixed(0)}ï¼Œ${teamStatistic.allTeamUserCount}äººå†æŠ¢ï¼Œå‚ä¸é©¬ä¸ŠæŠ¢åˆ°`;

                groupList.innerHTML = '';

                if (teamList.length === 0) {
                    groupList.innerHTML = `
          <div class="group-item empty-tips">
              <div class="tips-content">
                  å°ä¼™ä¼´ï¼Œèµ¶ç´§å»å¼€å›¢å§ï¼Œåšæ‘é‡Œæœ€é“çš„ä»”ï¼ğŸ‰
              </div>
          </div>`;
                } else {
                    teamList.forEach(team => {
                        const remaining = team.targetCount - team.lockCount;
                        groupList.innerHTML += `
            <div class="group-item">
                <div>
                    <div class="user-info" data-teamId="${team.teamId}" data-activityId="${team.activityId}">${obfuscateUserId(team.userId)}</div>
                    <div class="group-status">
                        <span>ç»„é˜Ÿä»…å‰©${remaining}äººï¼Œæ‹¼å•å³å°†ç»“æŸ</span>
                        <span class="countdown">${team.validTimeCountdown}</span>
                    </div>
                </div>
                <div class="right">
                    <button class="group-btn" data-price="${goods.payPrice.toFixed(0)}">å‚ä¸æ‹¼å›¢</button>
                </div>
            </div>`;
                    });
                }

                const buyAloneBtn = document.querySelector('.buy-alone');
                const groupBuyBtn = document.querySelector('.group-buy');
                buyAloneBtn.textContent = `å•ç‹¬è´­ä¹°(ï¿¥${goods.originalPrice.toFixed(0)})`;
                buyAloneBtn.dataset.price = goods.originalPrice;
                groupBuyBtn.textContent = `å¼€å›¢è´­ä¹°(ï¿¥${goods.payPrice.toFixed(0)})`;
                groupBuyBtn.dataset.price = goods.payPrice;

                document.querySelectorAll('.group-btn, .group-buy').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const price = this.dataset.price;
                        let teamId = null;
                        if (this.classList.contains('group-btn')) {
                            const groupItem = this.closest('.group-item');
                            const userInfo = groupItem.querySelector('.user-info');
                            teamId = userInfo.dataset.teamid;
                        }

                        const requestBody = {
                            userId: userId,
                            productId: goods.goodsId,
                            teamId: teamId,
                            activityId: activityId,
                            marketType: 1
                        };

                        fetch(sPayMallUrl + '/api/v1/alipay/create_pay_order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        })
                            .then(response => response.json())
                            .then(json => {
                                if (json.code === "0000") {
                                    document.querySelectorAll('form').forEach(form => form.remove());
                                    document.body.insertAdjacentHTML('beforeend', json.data);
                                    showPaymentConfirm(goods.payPrice);
                                } else {
                                    ELEMENT.Message.error('æ”¯ä»˜å¤±è´¥ï¼š' + (json.info || 'æœªçŸ¥é”™è¯¯'));
                                }
                            })
                            .catch(error => ELEMENT.Message.error('ç½‘ç»œé”™è¯¯ï¼š' + error.message));
                    });
                });

                document.querySelectorAll('.buy-alone').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const requestBody = {
                            userId: userId,
                            productId: goods.goodsId,
                            marketType: 0
                        };

                        fetch(sPayMallUrl + '/api/v1/alipay/create_pay_order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        })
                            .then(response => response.json())
                            .then(json => {
                                if (json.code === "0000") {
                                    document.querySelectorAll('form').forEach(form => form.remove());
                                    document.body.insertAdjacentHTML('beforeend', json.data);
                                    showPaymentConfirm(goods.payPrice);
                                } else {
                                    ELEMENT.Message.error('æ”¯ä»˜å¤±è´¥ï¼š' + (json.info || 'æœªçŸ¥é”™è¯¯'));
                                }
                            })
                            .catch(error => ELEMENT.Message.error('ç½‘ç»œé”™è¯¯ï¼š' + error.message));
                    });
                });

                document.querySelectorAll('.countdown').forEach(el => {
                    new Countdown(el, el.textContent);
                });
            })
            .catch(err => ELEMENT.Message.error('åŠ è½½å¤±è´¥ï¼š' + err.message));
    });
</script>
</body>
</html>
